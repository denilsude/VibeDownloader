<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Vibe Studio - Command Center</title>

<link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
<link rel="manifest" href="{{ url_for('static', filename='images/site.webmanifest') }}">
<meta name="theme-color" content="#00ff7f">

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body, html { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #050505; 
        color: #e0e0e0; 
        min-height: 100vh; 
        display: flex; 
        flex-direction: column;
    }
    
    .container { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
    }
    
    .top-bar {
        width: 100%;
        max-width: 600px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 25px;
        background: linear-gradient(135deg, #0d0d0d, #1a1a1a);
        border-radius: 50px;
        border: 1px solid #222;
        margin-bottom: 20px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    
    .user-info { 
        display: flex; 
        align-items: center; 
        gap: 10px;
        color: #fff;
        font-weight: 600;
        font-size: 0.95em;
    }
    
    .status-dot { 
        width: 8px; 
        height: 8px; 
        background: #00ff7f; 
        border-radius: 50%; 
        box-shadow: 0 0 10px #00ff7f;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .btn-logout { 
        color: #ff5555; 
        text-decoration: none; 
        font-size: 0.9em; 
        font-weight: 600;
        transition: color 0.2s;
    }
    
    .btn-logout:hover { color: #ff8888; }

    .studio-box { 
        background: linear-gradient(135deg, #0d0d0d, #1a1a1a);
        padding: 40px 35px;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0, 255, 127, 0.1);
        border: 1px solid #222;
        width: 100%;
        max-width: 600px;
        position: relative;
    }
    
    .studio-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #00ff7f, #00bfff);
        border-radius: 24px 24px 0 0;
    }

    .logo-section {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .logo-img { 
        width: 70px; 
        height: 70px;
        border-radius: 16px; 
        box-shadow: 0 8px 25px rgba(0, 255, 127, 0.3);
        margin-bottom: 15px;
    }
    
    .studio-title { 
        font-size: 2em; 
        font-weight: 900; 
        background: linear-gradient(135deg, #00ff7f, #00bfff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        letter-spacing: -1px;
        margin: 0;
    }
    
    .studio-subtitle {
        color: #666;
        font-size: 0.85em;
        margin-top: 5px;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .flash { 
        padding: 15px 20px; 
        margin-bottom: 25px; 
        border-radius: 12px; 
        background: rgba(255, 80, 80, 0.1); 
        color: #ff9999; 
        border: 1px solid rgba(255, 80, 80, 0.3);
        font-size: 0.95em;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .input-wrapper { 
        display: flex; 
        gap: 10px; 
        margin-bottom: 15px; 
        align-items: center;
    }
    
    .url-input { 
        flex: 1; 
        padding: 16px 18px;
        border: 2px solid #222;
        border-radius: 12px;
        background-color: rgba(0, 0, 0, 0.3);
        color: #fff;
        outline: none;
        transition: all 0.3s;
        font-size: 1rem;
        font-family: inherit;
    }
    
    .url-input:focus { 
        border-color: #00ff7f;
        background-color: rgba(0, 0, 0, 0.5);
        box-shadow: 0 0 0 3px rgba(0, 255, 127, 0.1);
    }
    
    .url-input::placeholder { color: #555; }
    
    .btn-icon { 
        width: 48px; 
        height: 48px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        font-weight: bold;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .btn-add { 
        background: rgba(0, 255, 127, 0.1);
        color: #00ff7f;
        border: 1px solid rgba(0, 255, 127, 0.3);
    }
    
    .btn-add:hover { 
        background: #00ff7f;
        color: #000;
        transform: scale(1.05);
    }
    
    .btn-remove { 
        background: rgba(255, 80, 80, 0.1);
        color: #ff5555;
        border: 1px solid rgba(255, 80, 80, 0.3);
    }
    
    .btn-remove:hover { 
        background: #ff5555;
        color: #fff;
    }

    .format-selector { 
        margin: 30px 0;
        display: flex;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .format-option { cursor: pointer; position: relative; }
    .format-option input { display: none; }
    
    .format-option span { 
        padding: 12px 28px;
        border: 2px solid #222;
        border-radius: 30px;
        color: #666;
        transition: all 0.3s ease;
        display: inline-block;
        font-weight: 700;
        font-size: 0.9em;
        background: rgba(0, 0, 0, 0.3);
    }
    
    .format-option input:checked + span { 
        border-color: #00ff7f;
        color: #000;
        background: #00ff7f;
        box-shadow: 0 0 20px rgba(0, 255, 127, 0.4);
        transform: scale(1.05);
    }

    .btn-action { 
        width: 100%;
        padding: 18px;
        border: none;
        border-radius: 15px;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1.1em;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-top: 15px;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .btn-convert { 
        background: linear-gradient(135deg, #00ff7f 0%, #00cc66 100%);
        color: #000;
        box-shadow: 0 5px 20px rgba(0, 255, 127, 0.3);
    }
    
    .btn-convert:hover { 
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 255, 127, 0.4);
    }
    
    .btn-download { 
        background: linear-gradient(135deg, #00bfff 0%, #0088cc 100%);
        color: #000;
        box-shadow: 0 5px 20px rgba(0, 191, 255, 0.3);
    }
    
    .btn-download:hover { 
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 191, 255, 0.4);
    }

    .btn-restart { 
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        border: 1px solid #333;
        font-size: 0.95em;
        padding: 16px;
    }
    
    .btn-restart:hover { 
        background: rgba(255, 255, 255, 0.1);
        border-color: #555;
    }

    #loading-overlay { 
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
    }
    
    .pulse-ring { 
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #00ff7f;
        box-shadow: 0 0 0 0 rgba(0, 255, 127, 0.7);
        animation: pulse-ring 2s infinite;
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3em;
    }
    
    @keyframes pulse-ring { 
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 127, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 40px rgba(0, 255, 127, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 255, 127, 0); }
    }
    
    .loading-text { 
        font-size: 1.8em;
        font-weight: 900;
        color: #fff;
        margin-bottom: 15px;
        letter-spacing: 2px;
    }
    
    .loading-subtext { 
        color: #888;
        font-size: 1em;
        animation: pulse 1.5s ease-in-out infinite;
    }

    /* METADATA EDITOR */
    .metadata-editor {
        animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .editor-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .editor-badge {
        display: inline-block;
        background: rgba(0, 191, 255, 0.1);
        border: 1px solid rgba(0, 191, 255, 0.3);
        color: #00bfff;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        margin-bottom: 15px;
    }
    
    .editor-title {
        font-size: 1.3em;
        font-weight: 700;
        margin-bottom: 10px;
        color: #fff;
    }
    
    .editor-subtitle {
        color: #666;
        font-size: 0.9em;
    }
    
    .cover-preview {
        width: 150px;
        height: 150px;
        margin: 0 auto 25px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .cover-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .cover-placeholder {
        font-size: 3em;
        color: #333;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        color: #aaa;
        font-size: 0.85em;
        margin-bottom: 8px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .form-input {
        width: 100%;
        padding: 14px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #222;
        border-radius: 12px;
        color: #fff;
        font-size: 1rem;
        outline: none;
        transition: all 0.3s;
        font-family: inherit;
    }
    
    .form-input:focus {
        border-color: #00bfff;
        background: rgba(0, 0, 0, 0.5);
        box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.1);
    }
    
    .form-input::placeholder {
        color: #555;
    }

    .spek-container { 
        margin-top: 25px;
        background: rgba(0, 0, 0, 0.5);
        padding: 20px;
        border-radius: 16px;
        border: 1px solid #222;
    }
    
    .song-label { 
        color: #00ff7f;
        font-size: 0.95em;
        margin-bottom: 12px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .spek-img { 
        width: 100%;
        border-radius: 12px;
        display: block;
    }
    
    .success-badge {
        display: inline-block;
        background: rgba(0, 255, 127, 0.1);
        border: 1px solid rgba(0, 255, 127, 0.3);
        color: #00ff7f;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        .studio-box { padding: 30px 20px; }
        .studio-title { font-size: 1.6em; }
        .format-selector { gap: 8px; }
        .format-option span { padding: 10px 20px; font-size: 0.85em; }
    }
</style>

<script>
    function addInput() {
        const container = document.getElementById('inputs-container');
        if(container.children.length >= 10) { 
            alert('M√°ximo de 10 links por vez!'); 
            return; 
        }
        const div = document.createElement('div');
        div.className = 'input-wrapper';
        div.innerHTML = `
            <input type="text" name="urls[]" class="url-input" placeholder="Outro link..." autocomplete="off">
            <button type="button" class="btn-icon btn-remove" onclick="this.parentElement.remove()">√ó</button>
        `;
        container.appendChild(div);
    }
    
    function startLoading() {
        document.getElementById('loading-overlay').style.display = 'flex';
        const steps = [
            "Conectando aos servidores...",
            "Baixando em Alta Qualidade...",
            "Extraindo √Åudio Profissional...",
            "Processando Espectrograma...",
            "Compactando Arquivos...",
            "Finalizando..."
        ];
        let i = 0;
        const subtext = document.getElementById('loading-subtext');
        const interval = setInterval(() => { 
            if (i < steps.length) { 
                subtext.innerText = steps[i];
                i++;
            } else {
                clearInterval(interval);
            }
        }, 3000);
    }
    
    function applyMetadata() {
        const form = document.getElementById('metadataForm');
        const formData = new FormData(form);
        
        document.getElementById('loading-overlay').style.display = 'flex';
        document.getElementById('loading-subtext').textContent = 'Aplicando metadados...';
        
        fetch('/apply_metadata', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.download_url;
            } else {
                alert('Erro ao aplicar metadados: ' + (data.error || 'Desconhecido'));
                document.getElementById('loading-overlay').style.display = 'none';
            }
        })
        .catch(error => {
            alert('Erro: ' + error);
            document.getElementById('loading-overlay').style.display = 'none';
        });
    }
</script>
</head>
<body>

<div id="loading-overlay">
    <div class="pulse-ring">üéµ</div>
    <div class="loading-text">PROCESSANDO</div>
    <div id="loading-subtext" class="loading-subtext">Preparando seu √°udio...</div>
</div>

<div class="container">
    
    <div class="top-bar">
        <div class="user-info">
            <span class="status-dot"></span>
            {{ current_user.dj_name }}
        </div>
        <a href="/logout" class="btn-logout">Sair</a>
    </div>

    <div class="studio-box">
        <div class="logo-section">
            <img src="{{ url_for('static', filename='images/android-chrome-192x192.png') }}" class="logo-img" alt="Vibe Studio">
            <h1 class="studio-title">VIBE STUDIO</h1>
            <p class="studio-subtitle">Professional Audio Command Center</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash">‚ö†Ô∏è {{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if show_metadata_editor %}
        <div class="metadata-editor">
            <div class="editor-header">
                <div class="editor-badge">‚úèÔ∏è EDITOR & AN√ÅLISE</div>
                <h2 class="editor-title">Informa√ß√µes do Arquivo</h2>
                <p class="editor-subtitle">Confira o espectro e edite as tags antes de salvar</p>
            </div>
            
            <div class="cover-preview">
                {% if file_info.thumbnail %}
                <img src="{{ file_info.thumbnail }}" alt="Capa" id="coverPreview">
                {% else %}
                <div class="cover-placeholder">üéµ</div>
                {% endif %}
            </div>

            {% if file_info.spectrogram %}
            <div class="spek-container">
                <div class="song-label">
                    <i class="fas fa-wave-square"></i> An√°lise de Espectro
                </div>
                <img src="{{ url_for('static', filename=file_info.spectrogram) }}" class="spek-img" alt="Espectrograma">
                <p style="text-align: center; color: #666; font-size: 0.8em; margin-top: 10px;">
                    Verifique se o corte de frequ√™ncia atinge 20kHz+ para qualidade lossless.
                </p>
            </div>
            {% endif %}
            
            <form id="metadataForm" style="margin-top: 30px;">
                <input type="hidden" name="filename" value="{{ file_info.filename }}">
                <input type="hidden" name="cover_url" value="{{ file_info.thumbnail or '' }}">
                
                <div class="form-group">
                    <label class="form-label">Artista</label>
                    <input 
                        type="text" 
                        name="artist" 
                        class="form-input" 
                        value="{{ file_info.artist }}"
                        placeholder="Nome do artista"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">T√≠tulo</label>
                    <input 
                        type="text" 
                        name="title" 
                        class="form-input" 
                        value="{{ file_info.title }}"
                        placeholder="Nome da m√∫sica"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label">√Ålbum (Opcional)</label>
                    <input 
                        type="text" 
                        name="album" 
                        class="form-input" 
                        placeholder="Nome do √°lbum ou EP"
                    >
                </div>
                
                <button type="button" class="btn-action btn-download" onclick="applyMetadata()">
                    üíæ APLICAR TAGS E BAIXAR
                </button>
                
                <a href="/" class="btn-action btn-restart">
                    ‚ùå CANCELAR
                </a>
            </form>
        </div>
        {% elif not download_ready %}
        
        <div id="form-area">
            <form action="/" method="post" onsubmit="startLoading()" autocomplete="off">
                <div id="inputs-container">
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            name="urls[]" 
                            class="url-input" 
                            placeholder="Cole o link (YouTube, SoundCloud...)" 
                            required 
                            autocomplete="off"
                        >
                        <button type="button" class="btn-icon btn-add" onclick="addInput()">+</button>
                    </div>
                </div>

                <div class="format-selector">
                    <label class="format-option">
                        <input type="radio" name="format" value="mp3" checked>
                        <span>MP3 320</span>
                    </label>
                    <label class="format-option">
                        <input type="radio" name="format" value="wav">
                        <span>WAV</span>
                    </label>
                    <label class="format-option">
                        <input type="radio" name="format" value="flac">
                        <span>FLAC</span>
                    </label>
                    <label class="format-option">
                        <input type="radio" name="format" value="aiff">
                        <span>AIFF</span>
                    </label>
                </div>

                <button type="submit" class="btn-action btn-convert">
                    ‚ö° PROCESSAR AGORA
                </button>
            </form>
        </div>
        {% else %}
        
        <div>
            <div class="success-badge">
                ‚úì Processamento Conclu√≠do
            </div>
            
            {% for item in results %}
            <div class="spek-container">
                <div class="song-label">
                    üéµ {{ item.title }}
                </div>
                {% if item.spectrogram %}
                <img src="{{ url_for('static', filename=item.spectrogram) }}" class="spek-img" alt="Espectrograma">
                {% endif %}
            </div>
            {% endfor %}

            <a href="{{ url_for('download_file', filename=final_filename) }}" class="btn-action btn-download">
                {% if is_zip %}
                üì¶ BAIXAR PACOTE (.ZIP)
                {% else %}
                üíæ BAIXAR ARQUIVO
                {% endif %}
            </a>
            
            <a href="/" class="btn-action btn-restart">
                üîÑ NOVA CONVERS√ÉO
            </a>
        </div>
        {% endif %}
    </div>
</div>

</body>
</html>