name: Deploy VibeDownloader

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Baixar Código Novo (Checkout)
      uses: actions/checkout@v4

    - name: Executar Atualização no Servidor
      run: |
        # 1. CRIA BACKUP DO BANCO DE DADOS (SEGURANÇA TOTAL)
        sudo mkdir -p /root/backups_vibe
        if [ -f /root/VibeDownloader/vibe_v2.db ]; then
            sudo cp /root/VibeDownloader/vibe_v2.db /root/backups_vibe/vibe_backup_$(date +%Y%m%d_%H%M%S).db
            echo "✅ Backup do banco de dados realizado com sucesso."
        fi

        # 2. Configura Variáveis de Ambiente
        echo "MERCADOPAGO_ACCESS_TOKEN=${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}" > /root/VibeDownloader/.env
        echo "MERCADOPAGO_PUBLIC_KEY=${{ secrets.MERCADOPAGO_PUBLIC_KEY }}" >> /root/VibeDownloader/.env
        echo "FLASK_SECRET_KEY=${{ secrets.FLASK_SECRET_KEY }}" >> /root/VibeDownloader/.env
        echo "APP_URL=${{ secrets.APP_URL }}" >> /root/VibeDownloader/.env
        echo "DATABASE_URI=sqlite:///vibe_v2.db" >> /root/VibeDownloader/.env
        echo "FLASK_ENV=production" >> /root/VibeDownloader/.env
        
        # 3. Atualiza Código
        PROJECT_DIR="/root/VibeDownloader"
        cd "$PROJECT_DIR"
        
        # Garante permissões
        sudo chown -R root:root .
        
        # Força a atualização do código
        git fetch --all
        git reset --hard origin/main
        
        # 4. Atualiza Dependências
        if [ ! -d "venv" ]; then python3 -m venv venv; fi
        ./venv/bin/pip install --upgrade pip
        ./venv/bin/pip install -r requirements.txt --prefer-binary

        # 5. Reinicia o Serviço
        # Copia o serviço caso tenha mudado
        sudo cp vibe.service /etc/systemd/system/vibe.service
        sudo systemctl daemon-reload
        sudo systemctl restart vibe
        sudo systemctl status vibe --no-pager